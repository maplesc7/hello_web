<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no"
  />
  <title>Minute Vapor Timer</title>
  <style>
    /* ===================== VARIABLES ===================== */
    :root {
      --bg1: #0e0e1a;
      --bg2: #1a1a2e;
      --bg3: #000000;

      --glow: #ff45ff;
      --glow2: #45e6ff;
      --text: #ffffff;
      --wire-main: rgba(255, 255, 255, 0.9);
      --wire-sub: rgba(255, 255, 255, 0.5);
      --floor-grid-main: rgba(255, 69, 255, 0.7);
      --floor-grid-accent: rgba(69, 230, 255, 0.65);

      --panel-bg: rgba(0, 0, 0, 0.55);
      --panel-border: rgba(255, 255, 255, 0.28);
      --panel-blur: 14px;
      --accent: rgba(255,255,255,0.95);
      --accent-soft: rgba(255,255,255,0.7);
      --btn-bg: rgba(255,255,255,0.06);
      --btn-bg-hover: rgba(255,255,255,0.12);
      --btn-border: rgba(255,255,255,0.22);
      --danger: #ff6b6b;
      --ok: #7dffb3;

      --memo-bg: rgba(0, 0, 0, 0.42);
      --memo-border: rgba(255, 255, 255, 0.24);
      --memo-glow: color-mix(in srgb, var(--glow) 38%, transparent 62%);
      --memo-glow2: color-mix(in srgb, var(--glow2) 26%, transparent 74%);
      --memo-radius: 18px;
      --memo-h: clamp(170px, 30svh, 290px);

      /* ÁîªÈù¢‰∏ãUI„Å∂„Çì„ÅÆÈÄÄÈÅøÔºàcontrols + ‰ΩôÁôΩ + safe-areaÔºâ */
      --ui-safe-bottom: calc(env(safe-area-inset-bottom, 0px) + 110px);
    }

    /* ===================== RESET & BASE ===================== */
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--text);
      background: var(--bg1);
      -webkit-text-size-adjust: 100%;
      overflow-x: hidden;
    }

    body {
      min-height: 100vh;
      min-height: 100svh;
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
      padding-bottom: env(safe-area-inset-bottom, 0px);
      background:
        radial-gradient(circle at top, rgba(255, 255, 255, 0.12), transparent 55%),
        radial-gradient(circle at bottom, rgba(0, 0, 0, 0.9), var(--bg1));
    }

    /* ===================== SCENE & FLOOR GRID ===================== */
    .scene {
      position: relative;
      width: 100%;
      max-width: 100vw;
      min-height: 100vh;
      min-height: 100svh;
      overflow: hidden;
      box-sizing: border-box;
      padding-bottom: max(0px, env(safe-area-inset-bottom, 0px));
      background:
        radial-gradient(circle at top, var(--bg2), var(--bg1) 45%),
        radial-gradient(circle at bottom, var(--bg3), var(--bg1));
      display: grid;
      grid-template-rows: auto 1fr;
      align-items: start;
      justify-items: center;
      -webkit-tap-highlight-color: transparent;
    }

    .scene-grid {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 0;
    }

    .scene-grid::before {
      content: "";
      position: absolute;
      left: -24%;
      right: -24%;
      bottom: -18%;
      height: 65vh;
      background-image:
        linear-gradient(
          to top,
          rgba(0, 0, 0, 0.9) 0%,
          rgba(0, 0, 0, 0.55) 18%,
          rgba(255, 255, 255, 0.08) 55%,
          transparent 100%
        ),
        repeating-linear-gradient(
          to right,
          var(--floor-grid-main) 0,
          var(--floor-grid-main) 1.2px,
          transparent 1.2px,
          transparent 34px
        ),
        repeating-linear-gradient(
          to top,
          var(--floor-grid-accent) 0,
          var(--floor-grid-accent) 1.2px,
          transparent 1.2px,
          transparent 36px
        );
      opacity: 0.8;
      transform-origin: bottom center;
      transform: perspective(900px) rotateX(70deg);
      filter: blur(0.35px);
      mix-blend-mode: screen;
    }

    /* ===================== TOP MEMO ===================== */
    .memo-wrap {
      position: relative;
      z-index: 2;
      width: min(920px, calc(100vw - 28px));
      margin-top: max(14px, env(safe-area-inset-top, 0px));
      padding: 12px;
      border-radius: var(--memo-radius);
      background: linear-gradient(
        180deg,
        color-mix(in srgb, var(--memo-bg) 90%, transparent 10%),
        color-mix(in srgb, var(--memo-bg) 70%, transparent 30%)
      );
      border: 1px solid var(--memo-border);
      backdrop-filter: blur(18px);
      box-shadow:
        0 18px 60px rgba(0, 0, 0, 0.62),
        0 0 0 1px rgba(255,255,255,0.06) inset,
        0 0 28px var(--memo-glow),
        0 0 44px var(--memo-glow2);
      overflow: hidden;
    }

    .memo-wrap::before {
      content: "";
      position: absolute;
      inset: -2px;
      background:
        radial-gradient(circle at 15% 10%, rgba(255,255,255,0.12), transparent 45%),
        radial-gradient(circle at 85% 0%, color-mix(in srgb, var(--glow) 26%, transparent 74%), transparent 52%),
        radial-gradient(circle at 90% 120%, color-mix(in srgb, var(--glow2) 24%, transparent 76%), transparent 58%);
      opacity: 0.9;
      pointer-events: none;
      filter: blur(0.2px);
      mix-blend-mode: screen;
    }

    .memo-head {
      position: relative;
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 8px;
      padding: 2px 2px 0;
      user-select: none;
    }

    .memo-title {
      font-size: 10px; /* 20%Â∞è„Åï„ÇÅ */
      letter-spacing: 0.06em;
      opacity: 0.92;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .memo-title .badge {
      font-size: 10px;
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.06);
      opacity: 0.92;
    }

    .memo-hint {
      font-size: 10px;
      opacity: 0.72;
      white-space: nowrap;
    }

    .memo-area {
      position: relative;
      width: 100%;
      height: var(--memo-h);
      box-sizing: border-box;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.22);
      box-shadow:
        0 0 0 1px rgba(255,255,255,0.06) inset,
        0 14px 40px rgba(0,0,0,0.35);
      overflow: hidden;
    }

    textarea.memo {
      width: 100%;
      height: 100%;
      resize: none;
      border: 0;
      outline: none;
      padding: 14px 14px;
      box-sizing: border-box;
      color: var(--text);
      background: transparent;
      font-size: 12px; /* 20%Â∞è„Åï„ÇÅ */
      line-height: 1.6;
      letter-spacing: 0.02em;
      overflow: auto;
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
    }

    textarea.memo::placeholder {
      color: rgba(255,255,255,0.5);
    }

    .memo-footer {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-top: 8px;
      padding: 0 2px 2px;
      font-size: 10px; /* 20%Â∞è„Åï„ÇÅ */
      opacity: 0.78;
      user-select: none;
    }

    .memo-meta {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      white-space: nowrap;
    }

    .memo-mini {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.05);
    }

    .memo-mini kbd {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 7px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      opacity: 0.95;
    }

    @media (max-width: 480px) {
      .memo-hint { display: none; }
    }

    /* ===================== MID AREA (for clock placement) ===================== */
    .mid-area {
      position: relative;
      z-index: 1;
      width: 100%;
      display: flex;
      align-items: flex-end;
      justify-content: center;

      /* „É°„É¢‰∏ãÁ´Ø„Äú‰∏ãUI„ÅÆÈñì„Åè„Çâ„ÅÑ„Å´ÁΩÆ„Åè„Åü„ÇÅ„Å´„ÄÅ‰∏ãUIÂàÜ„ÇíÈÅø„Åë„Å¶‰∏ãÂØÑ„Åõ */
      padding: 16px 0 var(--ui-safe-bottom);
      box-sizing: border-box;
    }

    /* ===================== CLOCK / TIMER DISPLAY ===================== */
    .clock {
      user-select: none;
      pointer-events: none;
      text-align: center;
      text-shadow:
        0 0 22px var(--glow),
        0 0 44px var(--glow2),
        0 0 70px rgba(0, 0, 0, 0.9);
      animation: pulse 6s ease-in-out infinite;
    }

    .clock .minutes-line {
      font-size: clamp(88px, 19.2vw, 184px); /* Á¥Ñ20%Â∞è„Åï„ÇÅ */
      font-weight: 600;
      letter-spacing: -0.04em;
      line-height: 1.0;
      white-space: nowrap;
    }

    .clock .minutes-unit {
      font-size: 0.28em;
      font-weight: 500;
      opacity: 0.9;
      margin-left: 0.12em;
      letter-spacing: 0;
    }

    .clock .nowtime {
      margin-top: 6px;
      font-size: clamp(18px, 4.2vw, 28px); /* 1Ë°å‰∏ã„Å´Â∏∏ÊôÇË°®Á§∫ */
      font-weight: 550;
      letter-spacing: 0.06em;
      opacity: 0.92;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; filter: hue-rotate(0deg); }
      50% { opacity: 0.86; filter: hue-rotate(18deg); }
    }

    @media (max-height: 700px) {
      .clock .minutes-line {
        font-size: clamp(78px, 18vw, 168px);
      }
      .clock .nowtime {
        font-size: clamp(16px, 3.8vw, 26px);
      }
      .mid-area {
        padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 100px);
      }
    }

    /* ===================== THEMES ===================== */
    /* „Éá„Éï„Ç©„É´„Éà„ÅØÊéß„Åà„ÇÅÔºàÊåáÂÆöÈÄö„ÇäÔºâ */

    [data-theme="cyber"] {
      --bg1: #00110f;
      --bg2: #003b36;
      --bg3: #001f2b;
      --glow: #00ffaa;
      --glow2: #00ccff;
      --text: #eaffff;
      --wire-main: rgba(0, 255, 170, 0.95);
      --wire-sub: rgba(0, 204, 255, 0.7);
      --floor-grid-main: rgba(0, 255, 170, 0.82);
      --floor-grid-accent: rgba(0, 204, 255, 0.78);
      --panel-bg: rgba(0, 0, 0, 0.45);
    }

    [data-theme="sunset"] {
      --bg1: #1a0d0d;
      --bg2: #4d1a1a;
      --bg3: #2b001a;
      --glow: #ff4d6d;
      --glow2: #ffd166;
      --text: #ffe6e6;
      --wire-main: rgba(255, 77, 109, 0.95);
      --wire-sub: rgba(255, 209, 102, 0.75);
      --floor-grid-main: rgba(255, 77, 109, 0.84);
      --floor-grid-accent: rgba(255, 209, 102, 0.78);
    }

    [data-theme="ocean"] {
      --bg1: #020817;
      --bg2: #012a4a;
      --bg3: #001b3a;
      --glow: #00b4ff;
      --glow2: #7c3aed;
      --text: #e0f2fe;
      --wire-main: rgba(56, 189, 248, 0.95);
      --wire-sub: rgba(124, 58, 237, 0.75);
      --floor-grid-main: rgba(56, 189, 248, 0.86);
      --floor-grid-accent: rgba(124, 58, 237, 0.72);
    }

    [data-theme="violet"] {
      --bg1: #120021;
      --bg2: #2a0a4a;
      --bg3: #1a0033;
      --glow: #c471ff;
      --glow2: #00e5ff;
      --text: #f5e9ff;
      --wire-main: rgba(196, 113, 255, 0.95);
      --wire-sub: rgba(0, 229, 255, 0.72);
      --floor-grid-main: rgba(196, 113, 255, 0.86);
      --floor-grid-accent: rgba(0, 229, 255, 0.66);
    }

    [data-theme="amber"] {
      --bg1: #1b1204;
      --bg2: #4a2600;
      --bg3: #220a00;
      --glow: #ffb347;
      --glow2: #ff3d00;
      --text: #fff4dd;
      --wire-main: rgba(255, 179, 71, 0.95);
      --wire-sub: rgba(255, 61, 0, 0.7);
      --floor-grid-main: rgba(255, 179, 71, 0.88);
      --floor-grid-accent: rgba(255, 61, 0, 0.62);
    }

    [data-theme="mono"] {
      --bg1: #050506;
      --bg2: #141414;
      --bg3: #000000;
      --glow: #f5f5f5;
      --glow2: #9e9e9e;
      --text: #f5f5f5;
      --wire-main: rgba(245, 245, 245, 0.9);
      --wire-sub: rgba(158, 158, 158, 0.6);
      --floor-grid-main: rgba(245, 245, 245, 0.7);
      --floor-grid-accent: rgba(158, 158, 158, 0.65);
    }

    /* ===================== THEME PANEL UI ===================== */
    .theme-toggle {
      position: fixed;
      bottom: calc(env(safe-area-inset-bottom, 0px) + 16px);
      right: 16px;
      width: 44px;
      height: 44px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      backdrop-filter: blur(var(--panel-blur));
      color: #fff;
      font-size: 18px;
      cursor: pointer;
      z-index: 10;
      -webkit-tap-highlight-color: transparent;
    }

    .theme-panel {
      position: fixed;
      bottom: calc(env(safe-area-inset-bottom, 0px) + 76px);
      right: 16px;
      width: 246px;
      max-width: calc(100vw - 32px);
      background: rgba(6, 10, 30, 0.96);
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.24);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
      padding: 10px 12px 12px;
      backdrop-filter: blur(20px);
      z-index: 11;
      display: none;
    }

    .theme-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 12px; /* 20%Â∞è„Åï„ÇÅ */
      opacity: 0.9;
    }

    .theme-close {
      background: none;
      border: none;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      padding: 0 4px;
      -webkit-tap-highlight-color: transparent;
    }

    .theme-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .theme-chip {
      flex: 0 0 calc(50% - 3px);
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.28);
      background: rgba(255, 255, 255, 0.03);
      font-size: 11px;
      color: #fff;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    .theme-chip-swatch {
      width: 14px;
      height: 14px;
      border-radius: 999px;
      flex-shrink: 0;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.6);
    }

    .theme-chip.active {
      border-color: #ffffff;
      background: rgba(255, 255, 255, 0.08);
    }

    /* ===================== TIMER CONTROLS ===================== */
    .controls {
      position: fixed;
      bottom: calc(env(safe-area-inset-bottom, 0px) + 14px);
      left: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 14px;
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      backdrop-filter: blur(var(--panel-blur));
      z-index: 10;
      box-shadow: 0 10px 28px rgba(0,0,0,0.55);
      -webkit-tap-highlight-color: transparent;
    }

    .ctrl-btn {
      appearance: none;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 10px; /* 20%Â∞è„Åï„ÇÅ */
      font-weight: 650;
      letter-spacing: 0.02em;
      cursor: pointer;
      transition: background .15s ease, border-color .15s ease, transform .08s ease;
      min-width: 62px;
      text-align: center;
    }

    .ctrl-btn:hover { background: var(--btn-bg-hover); }
    .ctrl-btn:active { transform: translateY(1px) scale(0.98); }

    .ctrl-btn.primary {
      border-color: rgba(255,255,255,0.5);
      background: rgba(255,255,255,0.12);
    }

    .ctrl-btn.stop {
      border-color: color-mix(in srgb, var(--danger) 60%, white 0%);
      color: #fff;
    }

    .ctrl-btn.reset {
      border-color: rgba(255,255,255,0.18);
      opacity: 0.85;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.35);
      box-shadow: 0 0 8px rgba(255,255,255,0.35);
      margin-right: 2px;
    }

    .status-dot.running {
      background: var(--ok);
      box-shadow: 0 0 10px color-mix(in srgb, var(--ok) 70%, white 0%);
    }

    .status-text {
      font-size: 10px; /* 20%Â∞è„Åï„ÇÅ */
      opacity: 0.85;
      margin-right: 6px;
      user-select: none;
      white-space: nowrap;
    }

    @media (max-width: 480px) {
      .theme-panel {
        bottom: calc(env(safe-area-inset-bottom, 0px) + 72px);
        right: 12px;
        left: 12px;
        margin: 0 auto;
      }

      .theme-toggle { right: 12px; }

      .controls {
        left: 10px;
        right: 70px;
        justify-content: space-between;
      }

      .ctrl-btn {
        min-width: 58px;
        padding: 8px 10px;
      }
    }
  </style>
</head>
<body>
  <div class="scene" id="scene">
    <div class="scene-grid"></div>

    <!-- ‰∏ä1/3: „É°„É¢ -->
    <div class="memo-wrap" id="memoWrap">
      <div class="memo-head">
        <div class="memo-title">
          <span class="badge">MEMO</span>
          <span>Ëá™Áî±„É°„É¢</span>
        </div>
        <div class="memo-hint">„Åì„Åì„ÇíËß¶„Å£„Å¶„ÇÇË®àÊ∏¨„ÅØÂàá„ÇäÊõø„Çè„Çä„Åæ„Åõ„Çì</div>
      </div>

      <div class="memo-area">
        <textarea
          class="memo"
          id="memo"
          placeholder="ÊÄù„ÅÑ„Å§„ÅÑ„Åü„Åì„Å®„Çí„ÄÅ„Åù„ÅÆ„Åæ„Åæ„ÄÇ&#10;ÔºàÂÜÖÂÆπ„ÅØÁ´ØÊú´„Å´‰øùÂ≠ò„Åï„Çå„Åæ„ÅôÔºâ"
          spellcheck="false"
        ></textarea>
      </div>

      <div class="memo-footer">
        <div class="memo-meta">
          <span class="memo-mini"><kbd>Ctrl</kbd>+<kbd>Enter</kbd> „ÅßË®àÊ∏¨ÂàáÊõø</span>
          <span class="memo-mini">‰øùÂ≠ò: Ëá™Âãï</span>
        </div>
        <div class="memo-meta">
          <span id="memoCount" class="memo-mini">0 ÊñáÂ≠ó</span>
        </div>
      </div>
    </div>

    <!-- ‰∏≠ÊÆµ: ÂàÜË°®Á§∫ + ÁèæÂú®ÊôÇÂàªÔºà‰∏ãUI„Å®„ÅÆÈñì„ÅÇ„Åü„ÇäÔºâ -->
    <div class="mid-area" id="midArea">
      <div class="clock" id="clock" aria-label="ÁµåÈÅéÂàÜ„Å®ÁèæÂú®ÊôÇÂàª">
        <div class="minutes-line">
          <span id="minuteValue">0</span><span class="minutes-unit">ÂàÜ</span>
        </div>
        <div class="nowtime" id="timeNow">--:--</div>
      </div>
    </div>

    <!-- „Çø„Ç§„Éû„ÉºÊìç‰Ωú -->
    <div class="controls" role="group" aria-label="„Çø„Ç§„Éû„ÉºÊìç‰Ωú">
      <span class="status-dot" id="statusDot" aria-hidden="true"></span>
      <span class="status-text" id="statusText">ÂÅúÊ≠¢‰∏≠</span>

      <button class="ctrl-btn primary" id="startBtn" type="button">
        „Çπ„Çø„Éº„Éà
      </button>
      <button class="ctrl-btn stop" id="stopBtn" type="button" disabled>
        „Çπ„Éà„ÉÉ„Éó
      </button>
      <button class="ctrl-btn reset" id="resetBtn" type="button">
        „É™„Çª„ÉÉ„Éà
      </button>
    </div>

    <!-- „ÉÜ„Éº„Éû -->
    <button
      class="theme-toggle"
      id="themeToggle"
      type="button"
      aria-label="„ÉÜ„Éº„ÉûÂàá„ÇäÊõø„Åà"
    >
      üé®
    </button>

    <div class="theme-panel" id="themePanel">
      <div class="theme-panel-header">
        <span>„ÉÜ„Éº„ÉûÈÅ∏Êäû</span>
        <button type="button" class="theme-close" id="themeClose">√ó</button>
      </div>
      <div class="theme-list" id="themeList"></div>
    </div>
  </div>

  <script>
    /* =========================================================
       Minute-only Count Up Timer
       - Áßí„ÅØË°®Á§∫„Åó„Å™„ÅÑ
       - 0ÂàÜ„Åã„ÇâÈñãÂßã
       - ÁµåÈÅéÊôÇÈñì„ÅØ Date.now() „Éô„Éº„Çπ„ÅßË®àÁÆó„Åó„Å¶„Ç∫„É¨„ÇíÊúÄÂ∞èÂåñ
       - Áä∂ÊÖã„Çí localStorage „Å´‰øùÂ≠ò
       - „É°„Ç§„É≥ÁîªÈù¢(„Éú„Çø„É≥‰ª•Â§ñ)„ÇØ„É™„ÉÉ„ÇØ/„Çø„ÉÉ„Éó„Åß„ÇÇ Start/Stop ÂàáÊõø
       - „É°„É¢„ÅØ localStorage „Å´Ëá™Âãï‰øùÂ≠ò
       - ÁèæÂú®ÊôÇÂàª(HH:MM)„ÇíÂ∏∏ÊôÇË°®Á§∫ÔºàÂàÜÂàáÊõø„ÅßÊõ¥Êñ∞Ôºâ
    ========================================================= */

    const minuteValueEl = document.getElementById("minuteValue");
    const timeNowEl     = document.getElementById("timeNow");

    const statusDotEl   = document.getElementById("statusDot");
    const statusTextEl  = document.getElementById("statusText");
    const startBtn      = document.getElementById("startBtn");
    const stopBtn       = document.getElementById("stopBtn");
    const resetBtn      = document.getElementById("resetBtn");
    const sceneEl       = document.getElementById("scene");

    const memoEl        = document.getElementById("memo");
    const memoWrapEl    = document.getElementById("memoWrap");
    const memoCountEl   = document.getElementById("memoCount");

    const STORAGE_KEY = "minute-vapor-timer:v1";
    const MEMO_KEY    = "minute-vapor-memo:v1";
    const THEME_KEY   = "minute-vapor-theme:v1";

    let state = {
      running: false,
      startEpochMs: null,
      elapsedMs: 0
    };

    let tickHandle = null;
    let nowHandle  = null;

    function pad2(n) { return String(n).padStart(2, "0"); }

    function formatHHMM(d) {
      return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    }

    function renderNowTime() {
      timeNowEl.textContent = formatHHMM(new Date());
    }

    function scheduleNowTime() {
      if (nowHandle) {
        clearTimeout(nowHandle);
        nowHandle = null;
      }
      // Ê¨°„ÅÆÂàÜÂ¢ÉÁïå„Å´Âêà„Çè„Åõ„Å¶Êõ¥Êñ∞
      const now = new Date();
      const ms = now.getSeconds() * 1000 + now.getMilliseconds();
      const wait = Math.max(250, 60000 - ms);
      nowHandle = setTimeout(() => {
        renderNowTime();
        scheduleNowTime();
      }, wait);
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (
          typeof parsed === "object" &&
          parsed &&
          typeof parsed.running === "boolean" &&
          (parsed.startEpochMs === null || Number.isFinite(parsed.startEpochMs)) &&
          Number.isFinite(parsed.elapsedMs)
        ) {
          state = parsed;
        }
      } catch (_) {}
    }

    function saveState() {
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch (_) {}
    }

    function nowElapsedMs() {
      if (!state.running) return state.elapsedMs;
      if (!state.startEpochMs) return state.elapsedMs;
      const delta = Date.now() - state.startEpochMs;
      return Math.max(0, state.elapsedMs + delta);
    }

    function render() {
      const ms = nowElapsedMs();
      const minutes = Math.floor(ms / 60000);
      minuteValueEl.textContent = String(minutes);

      statusDotEl.classList.toggle("running", state.running);
      statusTextEl.textContent = state.running ? "Ë®àÊ∏¨‰∏≠" : "ÂÅúÊ≠¢‰∏≠";

      startBtn.disabled = state.running;
      stopBtn.disabled  = !state.running;

      // ÊôÇÂàª„ÇÇ„ÄåÂ∏∏„Å´„ÄçË°®Á§∫Êõ¥Êñ∞Ôºà‰∏ª„Å´Âæ©Â∏∞ÊôÇÔºâ
      renderNowTime();
    }

    function scheduleTick() {
      if (tickHandle) {
        clearTimeout(tickHandle);
        tickHandle = null;
      }
      if (!state.running) return;

      const ms = nowElapsedMs();
      const remainder = ms % 60000;
      const wait = Math.max(250, 60000 - remainder);
      tickHandle = setTimeout(() => {
        render();
        scheduleTick();
      }, wait);
    }

    function start() {
      if (state.running) return;
      state.running = true;
      state.startEpochMs = Date.now();
      saveState();
      render();
      scheduleTick();
    }

    function stop() {
      if (!state.running) return;
      state.elapsedMs = nowElapsedMs();
      state.running = false;
      state.startEpochMs = null;
      saveState();

      if (tickHandle) {
        clearTimeout(tickHandle);
        tickHandle = null;
      }
      render();
    }

    function toggleStartStop() {
      if (state.running) stop();
      else start();
    }

    function reset() {
      state.running = false;
      state.startEpochMs = null;
      state.elapsedMs = 0;
      saveState();

      if (tickHandle) {
        clearTimeout(tickHandle);
        tickHandle = null;
      }
      render();
    }

    startBtn.addEventListener("click", (e) => { e.stopPropagation(); start(); });
    stopBtn.addEventListener("click",  (e) => { e.stopPropagation(); stop(); });
    resetBtn.addEventListener("click", (e) => { e.stopPropagation(); reset(); });

    // „Éú„Çø„É≥‰ª•Â§ñ„ÅÆ„É°„Ç§„É≥ÁîªÈù¢„ÇØ„É™„ÉÉ„ÇØ/„Çø„ÉÉ„Éó„Åß Start/Stop
    function isExcludedTarget(target) {
      const t = target;
      return (
        t.closest(".controls") ||
        t.closest(".theme-panel") ||
        t.closest(".theme-toggle") ||
        t.closest(".theme-chip") ||
        t.closest(".theme-close") ||
        t.closest(".memo-wrap")
      );
    }

    sceneEl.addEventListener("pointerup", (ev) => {
      if (isExcludedTarget(ev.target)) return;
      toggleStartStop();
    });

    // Ctrl+Enter „ÅßË®àÊ∏¨ÂàáÊõø
    document.addEventListener("keydown", (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
        e.preventDefault();
        toggleStartStop();
      }
    });

    // ===================== MEMO (localStorage) =====================
    let memoSaveHandle = null;

    function setMemoCount() {
      const n = (memoEl.value || "").length;
      memoCountEl.textContent = `${n} ÊñáÂ≠ó`;
    }

    function loadMemo() {
      try {
        const s = localStorage.getItem(MEMO_KEY);
        if (typeof s === "string") memoEl.value = s;
      } catch (_) {}
      setMemoCount();
    }

    function saveMemoNow() {
      try { localStorage.setItem(MEMO_KEY, memoEl.value || ""); } catch (_) {}
    }

    function scheduleMemoSave() {
      if (memoSaveHandle) clearTimeout(memoSaveHandle);
      memoSaveHandle = setTimeout(() => {
        saveMemoNow();
        memoSaveHandle = null;
      }, 250);
    }

    memoEl.addEventListener("input", () => {
      setMemoCount();
      scheduleMemoSave();
    });

    memoEl.addEventListener("blur", saveMemoNow);
    memoWrapEl.addEventListener("pointerup", (e) => e.stopPropagation());

    // ===================== THEME SWITCH =====================
    // „Éá„Éï„Ç©„É´„Éà„Å†„ÅëÊéß„Åà„ÇÅ„ÄÅ‰ªñ„ÅØÂ§ßËÉÜ„Ç∞„É©„Éá
    const themeDefs = [
      { id: "default", label: "Ëí∏Ê∞óÔºàÊ®ôÊ∫ñÔºâ", swatch: "linear-gradient(135deg,#23233b,#0e0e1a)" },

      { id: "cyber",   label: "„Çµ„Ç§„Éê„ÉºÔºàÁ∑ë√óÈùíÔºâ",
        swatch: "linear-gradient(135deg,#00ffaa 0%,#00ccff 45%,#0047ff 100%)" },

      { id: "sunset",  label: "„Çµ„É≥„Çª„ÉÉ„ÉàÔºàÁ¥Ö√óÈáëÔºâ",
        swatch: "linear-gradient(135deg,#ff2d55 0%,#ff7a18 45%,#ffd166 100%)" },

      { id: "ocean",   label: "„Ç™„Éº„Ç∑„É£„É≥ÔºàÈùí√óÁ¥´Ôºâ",
        swatch: "linear-gradient(135deg,#00b4ff 0%,#0044ff 45%,#7c3aed 100%)" },

      { id: "violet",  label: "„Éê„Ç§„Ç™„É¨„ÉÉ„ÉàÔºàÁ¥´√ó„Ç∑„Ç¢„É≥Ôºâ",
        swatch: "linear-gradient(135deg,#c471ff 0%,#7f00ff 45%,#00e5ff 100%)" },

      { id: "amber",   label: "„Ç¢„É≥„Éê„ÉºÔºàÁê•ÁèÄ√óÁ¥ÖÔºâ",
        swatch: "linear-gradient(135deg,#ffb347 0%,#ff6a00 45%,#ff3d00 100%)" },

      { id: "mono",    label: "„É¢„Éé„ÇØ„É≠ÔºàÁôΩ√óÈªíÔºâ",
        swatch: "linear-gradient(135deg,#f5f5f5 0%,#8a8a8a 50%,#050506 100%)" }
    ];

    const rootEl   = document.documentElement;
    const panelEl  = document.getElementById("themePanel");
    const toggleEl = document.getElementById("themeToggle");
    const closeEl  = document.getElementById("themeClose");
    const listEl   = document.getElementById("themeList");

    function applyTheme(id) {
      if (id === "default") rootEl.removeAttribute("data-theme");
      else rootEl.setAttribute("data-theme", id);

      try { localStorage.setItem(THEME_KEY, id); } catch (_) {}

      listEl.querySelectorAll(".theme-chip").forEach(chip => {
        chip.classList.toggle("active", chip.dataset.themeId === id);
      });
    }

    function loadTheme() {
      try {
        const id = localStorage.getItem(THEME_KEY);
        if (id) return id;
      } catch (_) {}
      return "default";
    }

    function buildThemeList() {
      const frag = document.createDocumentFragment();
      themeDefs.forEach(theme => {
        const chip = document.createElement("button");
        chip.type = "button";
        chip.className = "theme-chip";
        chip.dataset.themeId = theme.id;

        const swatch = document.createElement("span");
        swatch.className = "theme-chip-swatch";
        swatch.style.background = theme.swatch;

        const label = document.createElement("span");
        label.textContent = theme.label;

        chip.appendChild(swatch);
        chip.appendChild(label);

        chip.addEventListener("click", (e) => {
          e.stopPropagation();
          applyTheme(theme.id);
        });

        frag.appendChild(chip);
      });
      listEl.innerHTML = "";
      listEl.appendChild(frag);
    }

    buildThemeList();
    applyTheme(loadTheme());

    toggleEl.addEventListener("click", (e) => {
      e.stopPropagation();
      const showing = panelEl.style.display === "block";
      panelEl.style.display = showing ? "none" : "block";
    });

    closeEl.addEventListener("click", (e) => {
      e.stopPropagation();
      panelEl.style.display = "none";
    });

    document.addEventListener("click", (event) => {
      if (
        panelEl.style.display === "block" &&
        !panelEl.contains(event.target) &&
        event.target !== toggleEl
      ) {
        panelEl.style.display = "none";
      }
    });

    // ===================== INIT =====================
    loadState();
    loadMemo();
    render();

    // ÊôÇÂàªË°®Á§∫„ÅØÂ∏∏ÊôÇÔºàÂàÜÂ¢ÉÁïå„ÅßÊõ¥Êñ∞Ôºâ
    renderNowTime();
    scheduleNowTime();

    if (state.running) scheduleTick();

    document.addEventListener("visibilitychange", () => {
      if (!document.hidden) {
        render();
        scheduleTick();
        renderNowTime();
        scheduleNowTime();
      }
    });
  </script>
</body>
</html>
