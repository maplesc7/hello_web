<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Count Up Tools</title>
  <style>
    :root {
      --wave-opacity: 0.8;
      /* ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ç”¨ã‚«ãƒ©ãƒ¼ */
      --light-background-color: #ffffff;
      --light-text-color: #333333;
      --light-container-bg: #e4e6bd;
      --light-textarea-bg: #eceeb8;
      --light-textarea-text: #626343;
      --light-textarea-border: #616313;
      --light-button-bg: #c6c89c;
      --light-button-text: #7f8064;
      --light-button-hover: #d0d0d0;
      --flash-color-light: #ffcccc;
      --flash-stop-color-light: #ffffcc;
      
      /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ç”¨ã‚«ãƒ©ãƒ¼ */
      --dark-background-color: #121212;
      --dark-text-color: #e0e0e0;
      --dark-container-bg: rgba(100, 100, 100, 0.4);
      --dark-textarea-bg: #3c3400;
      --dark-textarea-text: #ffffff;
      --dark-textarea-border: #555;
      --dark-button-bg: #3a3a3a;
      --dark-button-text: #ffffff;
      --dark-button-hover: #555;
      --flash-color-dark: #990000;
      --flash-stop-color-dark: #999900;

      /* ç¾åœ¨æ™‚åˆ»ãƒ»åˆ†ï¼ˆã¾ãŸã¯æ™‚:åˆ†ï¼‰ã®æ–‡å­—è‰² */
      --current-time-color: #80990f;
    }
    html {
      overflow: hidden;
    }
    body.light-mode {
      --background-color: var(--light-background-color);
      --text-color: var(--light-text-color);
      --container-bg: var(--light-container-bg);
      --textarea-bg: var(--light-textarea-bg);
      --textarea-text: var(--light-textarea-text);
      --textarea-border: var(--light-textarea-border);
      --button-bg: var(--light-button-bg);
      --button-text: var(--light-button-text);
      --button-hover: var(--light-button-hover);
      --flash-color: var(--flash-color-light);
      --flash-stop-color: var(--flash-stop-color-light);
    }
    body.dark-mode {
      --background-color: var(--dark-background-color);
      --text-color: var(--dark-text-color);
      --container-bg: var(--dark-container-bg);
      --textarea-bg: var(--dark-textarea-bg);
      --textarea-text: var(--dark-textarea-text);
      --textarea-border: var(--dark-textarea-border);
      --button-bg: var(--dark-button-bg);
      --button-text: var(--dark-button-text);
      --button-hover: var(--dark-button-hover);
      --flash-color: var(--flash-color-dark);
      --flash-stop-color: var(--flash-stop-color-dark);
    }
    body {
      margin: 0;
      padding: 0;
      background-color: var(--background-color);
      color: var(--text-color);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      position: relative;
      transition: background-color 3s ease, color 3s ease;
    }
    body.flash {
      background-color: var(--flash-color);
    }
    body.flash textarea#purpose {
      background-color: var(--flash-color);
    }
    body.flash-stop {
      background-color: var(--flash-stop-color);
    }
    body.flash-stop textarea#purpose {
      background-color: var(--flash-stop-color);
    }

    /* èƒŒæ™¯ã®æ³¢ç·šï¼ˆçœç•¥å¯èƒ½ï¼‰ */
    .wave-bg {
      position: fixed;
      left: 7%;
      top: 0;
      width: 15vw;
      height: 100vh;
      z-index: -1;
    }
    .wave-bg svg {
      display: block;
      width: 100%;
      height: 100%;
    }
    .wave-bg path {
      stroke-opacity: var(--wave-opacity);
    }

    /* ãƒ©ãƒƒãƒ‘ãƒ¼ã‚’ç¸¦ flexã€å…¨é«˜ 100vh ã« */
    #main-wrapper {
      display: flex;
      flex-direction: column;
      width: 920px;
      height: 100vh;
      margin: 0 auto;
    }

    /* ã‚¿ã‚¤ãƒãƒ¼ï¼‹ãƒ¡ãƒ¢éƒ¨åˆ†ã‚’æ®‹ã‚Šé ˜åŸŸã„ã£ã±ã„ã« */
    .container {
      flex: 1;
      background-color: var(--container-bg);
      display: flex;
      flex-direction: row;
      justify-content: space-around;
      border-radius: 5px;
    }

    .range-column {
      display: flex;
      flex-direction: row;
      align-items: center;
      flex: 0;
      height: 73px;
    }
    .time-vertical {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .range-column #currentTimeDisplay {
      flex: 1;
      text-align: center;
      color: var(--current-time-color);
    }
    .range-column div {
      font-size: 1.3rem;
      font-family: 'Fira Code', SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
      margin: 0;
      text-align: center;
    }

    .count-column {
      flex: 0 0 10ch;
      width: 10ch;
      min-width: 21ch;
      max-width: 21ch;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 73px;
    }
    .time-display {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      font-weight: bold;
      width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-align: center;
      color: #7d7f59;
    }
    .time-display .fraction {
      display: none;
    }
    .colored-minutes {
      color: var(--current-time-color);
    }

    .button-column {
      flex: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.2rem;
      height: 73px;
    }
    button {
      background-color: var(--button-bg);
      border: none;
      border-radius: 5px;
      color: var(--button-text);
      font-size: 0.8rem;
      cursor: pointer;
      transition: background-color 0.3s;
      height: 35px;
      width: 100px;
    }
    button:hover {
      background-color: var(--button-hover);
    }

    /* ãƒ¡ãƒ¢ç”¨ã‚«ãƒ©ãƒ ã‹ã‚‰å›ºå®šé«˜ã•ã‚’å‰Šé™¤ */
    .memo-column {
      flex: 3;
      display: flex;
      position: relative;
    }
    textarea#purpose {
      width: 98%;

      border: 2px solid var(--textarea-border);
      border-radius: 5px;
      background-color: var(--textarea-bg);
      color: var(--textarea-text);
      font-size: 1rem;
      resize: none;
      transition: background-color 3s ease, color 3s ease, border-color 3s ease;
      line-height: 1;
    }
    textarea:focus {
      outline: none;
      box-shadow: none;
      border: 1px solid #ccc;
    }

    /* ãƒ­ã‚°ç”¨ã¯ãŠå¥½ã¿ã§ */
    .log-container {
      flex: 0;
      /* display: none; */
    }
    .log-container textarea#log {
      width: 100%;
      height: 98%;
      box-sizing: border-box;
      border: 2px solid var(--textarea-border);
      border-radius: 5px;
      background-color: var(--textarea-bg);
      color: var(--textarea-text);
      font-size: 1.2rem;
      resize: none;
      transition: background-color 3s ease, color 3s ease, border-color 3s ease;
      line-height: 1;
      display: none;
    }
  </style>
</head>
<body class="light-mode">
  <div class="wave-bg" style="display:none;">
    <!-- SVGæ³¢ç·šï¼ˆç•¥ï¼‰ -->
  </div>

  <div id="main-wrapper">
    <div class="container">
      <div class="range-column">
        <div class="time-vertical">
          <div id="startTimeDisplay">----</div>
          <div id="currentTimeDisplay">----</div>
          <div id="stopTimeDisplay">----</div>
        </div>
      </div>
      <div class="count-column">
        <div class="time-display" id="timeDisplay">0:00</div>
      </div>
      <div class="button-column">
        <button id="startBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        <button id="stopBtn" disabled>ã‚¹ãƒˆãƒƒãƒ—</button>
      </div>
      <div class="memo-column">
        <textarea id="purpose" rows="3"></textarea>
      </div>
    </div>
    <div class="log-container">
      <textarea id="log" rows="5"></textarea>
    </div>
  </div>

  <script>
    // ç§’æ•°å˜ä½ã§ã®è¨­å®šå¤‰æ•°
    const FLASH_DURATION_SECONDS = 0;  // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã®æŒç¶šæ™‚é–“
    const FLASH_INTERVAL_SECONDS = 300;  // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã®é–“éš”
    
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const timeDisplay = document.getElementById('timeDisplay');
    const startTimeDisplay = document.getElementById('startTimeDisplay');
    const stopTimeDisplay = document.getElementById('stopTimeDisplay');
    const currentTimeDisplay = document.getElementById('currentTimeDisplay');
    const purpose = document.getElementById('purpose');
    const logTextarea = document.getElementById('log');
    
    let countInterval;
    let flashInterval;
    let startTime;  // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹æ™‚åˆ»ï¼ˆDateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰
    let startTimeStrGlobal = "";   // ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚ã®4æ¡æ™‚åˆ»æ–‡å­—åˆ—ã‚’ä¿æŒ
    
    // ãƒ­ã‚°ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«å†…å®¹ã‚’è¿½è¨˜ã™ã‚‹é–¢æ•°
    // æ–°è¦è¿½åŠ ã™ã‚‹å†…å®¹å†…ã§ã€æ”¹è¡Œã ã‘ã®è¡Œã¯é™¤å»ã™ã‚‹
    function appendLog(newContent) {
      const filteredContent = newContent.split("\n").filter(line => line.trim() !== "").join("\n");
      if (logTextarea.value === "") {
        logTextarea.value = filteredContent;
      } else {
        logTextarea.value += "\n" + filteredContent;
      }
    }
    
    // å°æ•°ç‚¹ä»¥ä¸‹2æ¡ã‚‚å«ã‚ãŸ "0:SS.ss" / "M:SS.ss" / "H:MM:SS.ss" å½¢å¼ã«å¤‰æ›
    function formatTime(totalSeconds) {
      totalSeconds = Math.max(0, totalSeconds);
      if (totalSeconds < 60) {
        const secInt = Math.floor(totalSeconds);
        const hundredths = Math.floor((totalSeconds - secInt) * 100);
        return "0:" + secInt.toString().padStart(2, '0') + "." + hundredths.toString().padStart(2, '0');
      } else if (totalSeconds < 3600) {
        const m = Math.floor(totalSeconds / 60);
        const s = totalSeconds % 60;
        const sInt = Math.floor(s);
        const hundredths = Math.floor((s - sInt) * 100);
        return m + ":" + sInt.toString().padStart(2, '0') + "." + hundredths.toString().padStart(2, '0');
      } else {
        const h = Math.floor(totalSeconds / 3600);
        const remainder = totalSeconds % 3600;
        const m = Math.floor(remainder / 60);
        const s = remainder % 60;
        const sInt = Math.floor(s);
        const hundredths = Math.floor((s - sInt) * 100);
        return h + ":" + m.toString().padStart(2, '0') + ":" + sInt.toString().padStart(2, '0') + "." + hundredths.toString().padStart(2, '0');
      }
    }
    
    // è¡¨ç¤ºæ›´æ–°ï¼šå°æ•°ç‚¹ä»¥ä¸‹ã¯å¸¸ã«éè¡¨ç¤º
    function updateDisplay(elapsedSeconds) {
      const formatted = formatTime(elapsedSeconds);
      const intPart = formatted.split(".")[0];
      const lastColonIndex = intPart.lastIndexOf(":");
      if (lastColonIndex !== -1) {
        const coloredPart = intPart.substring(0, lastColonIndex);
        const colon = ":";
        const remainingPart = intPart.substring(lastColonIndex + 1);
        timeDisplay.innerHTML = '<span class="colored-minutes">' + coloredPart + '</span>' + colon + remainingPart;
      } else {
        timeDisplay.textContent = intPart;
      }
    }
    
    // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ï¼šå‹•ä½œä¸­ã¯ --flash-colorã€åœæ­¢ä¸­ã¯ --flash-stop-color
    function flash() {
      if (countInterval) {
        document.body.classList.add('flash');
        setTimeout(() => {
          document.body.classList.remove('flash');
        }, FLASH_DURATION_SECONDS * 1000);
      } else {
        document.body.classList.add('flash-stop');
        setTimeout(() => {
          document.body.classList.remove('flash-stop');
        }, FLASH_DURATION_SECONDS * 1000);
      }
    }
    
    function startCount() {
      if (countInterval) {
        clearInterval(countInterval);
        countInterval = null;
      }
      if (flashInterval) {
        clearInterval(flashInterval);
      }
      flashInterval = setInterval(flash, FLASH_INTERVAL_SECONDS * 1000);
      
      const now = new Date();
      startTime = now;
      const startTimeStr = now.getHours().toString().padStart(2, '0') +
                           now.getMinutes().toString().padStart(2, '0');
      startTimeDisplay.textContent = startTimeStr;
      stopTimeDisplay.textContent = "----";
      updateDisplay(0);
      
      startBtn.disabled = false;
      stopBtn.disabled = false;
      
      // ä»¥ä¸‹ã€ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢å†…å®¹ã®å¤‰æ›´å‡¦ç†ï¼ˆãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹è¿½åŠ ã€ãƒ­ã‚°è¿½è¨˜ã€ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼ç­‰ï¼‰ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
      /*
      const currentContent = purpose.value;
      const newText = `- ğŸ”¶${startTimeStr}- ${currentContent}`;
      // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
      navigator.clipboard.writeText(newText).catch(err => console.error('Clipboard copy failed: ', err));
      // ãƒ­ã‚°ç”¨textareaã«ã‚‚å†…å®¹ã‚’è¿½è¨˜ï¼ˆç©ºè¡Œã¯é™¤å»ï¼‰
      appendLog(newText);
      // æœ«å°¾ã«æ”¹è¡Œã‚’è¿½åŠ ã—ã€ãƒ­ã‚°ç”¨ã‚¨ãƒªã‚¢ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
      if (!logTextarea.value.endsWith("\n")) {
        logTextarea.value += "\n";
      }
      logTextarea.focus();
      */
      
      // ã‚¹ãƒˆãƒƒãƒ—æ™‚ã«åˆ©ç”¨ã™ã‚‹ãŸã‚ã€é–‹å§‹æ™‚åˆ»æ–‡å­—åˆ—ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
      startTimeStrGlobal = startTimeStr;
      
      // 10msæ¯ã«æ›´æ–°
      countInterval = setInterval(() => {
        const elapsedSeconds = (Date.now() - startTime.getTime()) / 1000;
        updateDisplay(elapsedSeconds);
      }, 10);
    }
    
    function stopCount() {
      clearInterval(countInterval);
      countInterval = null;
      const now = new Date();
      const stopTimeStr = now.getHours().toString().padStart(2, '0') +
                          now.getMinutes().toString().padStart(2, '0');
      stopTimeDisplay.textContent = stopTimeStr;
      startBtn.disabled = false;
      stopBtn.disabled = true;
      if (flashInterval) {
        clearInterval(flashInterval);
      }
      flashInterval = setInterval(flash, FLASH_INTERVAL_SECONDS * 1000);
      
      // çµŒéæ™‚é–“ã®åˆ†æ•°ï¼ˆæ•´æ•°ï¼‰ã‚’è¨ˆç®—
      const elapsedMinutes = Math.floor((now.getTime() - startTime.getTime()) / 60000);
      
      // ä»¥ä¸‹ã€ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢å†…å®¹ã®å¤‰æ›´å‡¦ç†ï¼ˆãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹é™¤å»ã€ãƒ­ã‚°è¿½è¨˜ã€ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼ã€å†…å®¹ã‚¯ãƒªã‚¢ç­‰ï¼‰ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
      /*
      let currentContent = purpose.value;
      const prefix = `- ğŸ”¶${startTimeStrGlobal}- `;
      if (currentContent.startsWith(prefix)) {
        currentContent = currentContent.substring(prefix.length);
      }
      
      const finalText = `- ğŸ”·${startTimeStrGlobal}-${stopTimeStr} ${elapsedMinutes}m ${currentContent}`;
      
      logTextarea.value = logTextarea.value.replace(/\n+$/, '');
      
      navigator.clipboard.writeText(finalText).catch(err => console.error('Clipboard copy failed: ', err));
      appendLog(finalText);
      purpose.value = "";
      purpose.focus();
      */
    }
    
    function updateCurrentTime() {
      const now = new Date();
      const hh = now.getHours().toString().padStart(2, '0');
      const mm = now.getMinutes().toString().padStart(2, '0');
      currentTimeDisplay.textContent = hh + mm;
    }
    
    startBtn.addEventListener('click', startCount);
    stopBtn.addEventListener('click', stopCount);
    
    // ãƒ¡ãƒ¢ç”¨ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®ã‚­ãƒ¼ãƒ€ã‚¦ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
    // â€»é€šå¸¸ã®Tabã§ãƒœã‚¿ãƒ³å‹•ä½œã€Shift+Tabã§ãƒ­ã‚°ç”¨ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã¸ç§»å‹•ï¼ˆâ€»ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ç§»å‹•å‡¦ç†ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
    purpose.addEventListener('keydown', function(e) {
      if (e.key === 'Tab') {
        e.preventDefault();
        e.stopPropagation();
        if (e.shiftKey) {
          // Shift+Tabï¼šãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ç§»å‹•ï¼ˆãƒ­ã‚°ç”¨ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã¸ï¼‰â€»ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
          // logTextarea.focus();
        } else {
          // Tabï¼šãƒœã‚¿ãƒ³å‹•ä½œï¼ˆã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ä¸­ãªã‚‰ã‚¹ãƒˆãƒƒãƒ—ã€ãã†ã§ãªã‘ã‚Œã°ã‚¹ã‚¿ãƒ¼ãƒˆï¼‰
          if (countInterval) {
            stopCount();
          } else {
            startCount();
          }
        }
      } else if (e.key === 'Enter' && e.shiftKey && !e.isComposing) {
        e.preventDefault();
        startCount();
      }
    });
    
    // ãƒ­ã‚°ç”¨ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®ã‚­ãƒ¼ãƒ€ã‚¦ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
    // â€»é€šå¸¸ã®Tabã§ãƒœã‚¿ãƒ³å‹•ä½œã€Shift+Tabã§ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ç§»å‹•ï¼ˆãƒ¡ãƒ¢ç”¨ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã¸ï¼‰â€»ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ç§»å‹•å‡¦ç†ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
    logTextarea.addEventListener('keydown', function(e) {
      if (e.key === 'Tab') {
        e.preventDefault();
        if (e.shiftKey) {
          // Shift+Tabï¼šãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ç§»å‹•ï¼ˆãƒ¡ãƒ¢ç”¨ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã¸ï¼‰â€»ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
          // purpose.focus();
        } else {
          // Tabï¼šãƒœã‚¿ãƒ³å‹•ä½œ
          if (countInterval) {
            stopCount();
          } else {
            startCount();
          }
        }
      }
    });
    
    setInterval(updateCurrentTime, 1000);
    updateCurrentTime();
    
    if (!countInterval && !flashInterval) {
      flashInterval = setInterval(flash, FLASH_INTERVAL_SECONDS * 1000);
    }
    
    window.addEventListener('beforeunload', function (e) {
      const purposeValue = document.getElementById('purpose').value.trim();
      const logValue = document.getElementById('log').value.trim();
      if (purposeValue !== '' || logValue !== '') {
        // æ¨™æº–ã®ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
        e.preventDefault();
        e.returnValue = ''; // å¤ã„ãƒ–ãƒ©ã‚¦ã‚¶å‘ã‘
      }
    });
  </script>
</body>
</html>
