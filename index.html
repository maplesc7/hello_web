<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <meta name="apple-mobile-web-app-title" content="VaporClock" />
  <title>VaporClock</title>
  <meta name="theme-color" content="#000000" />

  <style>
    :root {
      /* Colors */
      --bg-deep: #0b1020;   /* 濃紺 */
      --bg-deeper: #05070d; /* さらに暗い */
      --neon-a: #ff3ea5;    /* マゼンタ */
      --neon-b: #ffb200;    /* オレンジ */

      /* Layout ratios */
      --top-margin-vh-min: 8;  /* 時計の上余白(%) */
      --top-margin-vh-max: 10; /* 端末差対応で最小/最大を許容 */
      --vanish-vh-min: 60;     /* 消失点の高さ(%) */
      --vanish-vh-max: 65;

      /* Typo */
      --clock-max-width: 68vw; /* 余白を少し残す */
      --clock-letter-spacing: -0.02em; /* ややタイトに */

      /* Glow */
      --glow-soft: 14px;
      --glow-strong: 28px;

      /* Noise */
      --noise-opacity: 0.045; /* ごく薄い */
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: linear-gradient(180deg, var(--bg-deep) 0%, var(--bg-deeper) 100%);
      color: #fff;
      -webkit-text-size-adjust: 100%;
      overscroll-behavior: none;
    }

    /* セーフエリア考慮 */
    .app {
      position: relative;
      height: 100%;
      width: 100%;
      padding-top: max(calc(var(--top-margin-vh-min) * 1vh), env(safe-area-inset-top));
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
      padding-bottom: env(safe-area-inset-bottom);
      display: grid;
      grid-template-rows: auto 1fr;
      box-sizing: border-box;
      touch-action: manipulation; /* 誤操作抑止 */
    }

    /* 時計 */
    .clock {
      place-self: start center;
      width: min(92vw, var(--clock-max-width));
      font-family: -apple-system, system-ui, "SF Pro Display", "SF Pro Text", Inter, Roboto, "Helvetica Neue", Arial, sans-serif;
      font-weight: 600;
      font-size: clamp(40px, 12.5vw, 88px);
      letter-spacing: var(--clock-letter-spacing);
      line-height: 1.05;
      text-align: center;
      background: linear-gradient(90deg, var(--neon-a), var(--neon-b));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow:
        0 0 1px rgba(255,255,255,0.2),
        0 0 var(--glow-soft) color-mix(in oklab, var(--neon-a) 60%, transparent),
        0 0 var(--glow-strong) color-mix(in oklab, var(--neon-b) 40%, transparent);
      user-select: none;
    }

    /* 描画レイヤ（SVG） */
    .scene {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
      contain: strict;
    }

    /* ノイズ(静止) */
    .noise {
      position: absolute;
      inset: 0;
      pointer-events: none;
      opacity: var(--noise-opacity);
      mix-blend-mode: overlay;
    }

    /* 回転時のガイダンス（縦固定の代替） */
    .orientation-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: #000;
      color: #fff;
      font-family: -apple-system, system-ui, "SF Pro Text", Inter, Roboto, sans-serif;
      z-index: 20;
    }
    @media (orientation: landscape) {
      .orientation-overlay { display: flex; }
    }

    /* ダーク固定（念のため） */
    @media (prefers-color-scheme: light) {
      :root { color-scheme: dark; }
    }
  </style>
</head>
<body>
  <div class="app" aria-label="VaporClock App">
    <div class="clock" id="clock" aria-live="polite" aria-atomic="true">00:00</div>

    <div class="scene" id="scene" aria-hidden="true">
      <!-- 背面：静止ノイズ (SVGフィルタ) -->
      <svg class="noise" viewBox="0 0 100 100" preserveAspectRatio="none" aria-hidden="true">
        <filter id="noiseFilter">
          <feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="2" stitchTiles="stitch"></feTurbulence>
          <feColorMatrix type="saturate" values="0" />
        </filter>
        <rect width="100%" height="100%" filter="url(#noiseFilter)" />
      </svg>

      <!-- メインシーン：高速道路＆ヤシ（SVG静止描画） -->
      <svg id="vapor-svg" viewBox="0 0 100 200" preserveAspectRatio="xMidYMid slice" aria-hidden="true">
        <defs>
          <!-- ネオン用グラデ -->
          <linearGradient id="neonGrad" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="var(--neon-a)" />
            <stop offset="100%" stop-color="var(--neon-b)" />
          </linearGradient>

          <!-- ネオングロー（フィルタ） -->
          <filter id="neonGlow" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur stdDeviation="0.8" result="blur1" />
            <feGaussianBlur stdDeviation="2.6" in="blur1" result="blur2" />
            <feMerge>
              <feMergeNode in="blur2" />
              <feMergeNode in="SourceGraphic" />
            </feMerge>
          </filter>

          <!-- 路面の微グラデ（暗部） -->
          <linearGradient id="groundGrad" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#070a12"/>
            <stop offset="100%" stop-color="#020308"/>
          </linearGradient>
        </defs>

        <!-- 背景の地面（下半分付近） -->
        <rect x="0" y="110" width="100" height="90" fill="url(#groundGrad)" />

        <!-- 消失点（縦比 60〜65% の中間＝62.5%付近）: viewBox高さ200に対して 125 -->
        <!-- 路面シルエット（台形） -->
        <polygon id="road" points="
          5,200  95,200  58,125  42,125
        " fill="#05070d" />

        <!-- 路肩ライン（ネオン） -->
        <polyline points="5,200 42,125" fill="none" stroke="url(#neonGrad)" stroke-width="0.8" filter="url(#neonGlow)" />
        <polyline points="95,200 58,125" fill="none" stroke="url(#neonGrad)" stroke-width="0.8" filter="url(#neonGlow)" />

        <!-- センターレーン（破線風に数本を静的配置） -->
        <g stroke="url(#neonGrad)" stroke-width="0.5" filter="url(#neonGlow)">
          <polyline points="50,190 50,175" />
          <polyline points="50,165 50,150" />
          <polyline points="50,140 50,130" />
        </g>

        <!-- 右側ヤシの木（シルエット + ネオン縁） -->
        <!-- 簡易ベクタ: 幹はわずかに右傾、葉は扇状に数本 -->
        <g transform="translate(78,120) scale(1,1)">
          <!-- 幹（影） -->
          <path d="M0,0 C2,20 2,60 1.2,80 C1,92 0,100 -0.6,112 L-4,112 C-3,96 -2,80 -2.6,68 C-3,56 -3,20 -1,0 Z"
                fill="#030308" />
          <!-- 幹（ネオン縁） -->
          <path d="M0,0 C2,20 2,60 1.2,80 C1,92 0,100 -0.6,112"
                fill="none" stroke="url(#neonGrad)" stroke-width="1.2" filter="url(#neonGlow)" />

          <!-- 葉（影） -->
          <g fill="none" stroke="#04050a" stroke-width="3">
            <path d="M0,2 C18,-10 34,-12 50,-10" />
            <path d="M0,4 C16,-4 30,-6 44,-4" />
            <path d="M0,6 C12,0 24,2 36,6" />
            <path d="M0,8 C-10,2 -22,4 -34,10" />
            <path d="M0,10 C-14,0 -28,-2 -40,-2" />
          </g>
          <!-- 葉（ネオン縁） -->
          <g fill="none" stroke="url(#neonGrad)" stroke-width="0.9" filter="url(#neonGlow)">
            <path d="M0,2 C18,-10 34,-12 50,-10" />
            <path d="M0,4 C16,-4 30,-6 44,-4" />
            <path d="M0,6 C12,0 24,2 36,6" />
            <path d="M0,8 C-10,2 -22,4 -34,10" />
            <path d="M0,10 C-14,0 -28,-2 -40,-2" />
          </g>
        </g>
      </svg>
    </div>
  </div>

  <div class="orientation-overlay" aria-hidden="true">縦向きでご利用ください</div>

  <script>
    (function() {
      'use strict';

      /* ==========================
         Utility: clamp helpers
      ========================== */
      const clamp = (val, min, max) => Math.min(Math.max(val, min), max);

      /* ==========================
         Time: minute-sync update
      ========================== */
      function formatHHMM(d) {
        const hh = String(d.getHours()).padStart(2, '0');
        const mm = String(d.getMinutes()).padStart(2, '0');
        return `${hh}:${mm}`;
      }

      function updateClockNow() {
        const el = document.getElementById('clock');
        el.textContent = formatHHMM(new Date());
      }

      function scheduleMinuteSync() {
        // 初回: 直ちに表示
        updateClockNow();
        // 次の00秒までの残りmsを算出
        const now = new Date();
        const msToNextMinute = (60 - now.getSeconds()) * 1000 - now.getMilliseconds();
        setTimeout(() => {
          updateClockNow();
          // 以後は毎分更新（ドリフト軽減のため再帰）
          scheduleMinuteSync();
        }, Math.max(0, msToNextMinute));
      }

      /* ==========================
         Wake Lock (best-effort)
      ========================== */
      let wakeLock = null;

      async function requestWakeLock() {
        try {
          if ('wakeLock' in navigator) {
            wakeLock = await navigator.wakeLock.request('screen');
            wakeLock.addEventListener && wakeLock.addEventListener('release', () => {
              // 何もしない（静かにフォールバック）
            });
          }
        } catch (e) {
          // iOS等で未対応/拒否の場合は無視
        }
      }

      function setupWakeLockAutoReacquire() {
        document.addEventListener('visibilitychange', () => {
          if (document.visibilityState === 'visible' && wakeLock !== null) {
            requestWakeLock();
          }
        });
        // 初回はユーザー操作が無くても一度試す（許可されない場合は静かに失敗）
        requestWakeLock();
        // タップ時にも再試行（iOS対策）
        window.addEventListener('pointerdown', () => requestWakeLock(), { passive: true });
      }

      /* ==========================
         Layout helpers
      ========================== */
      function adjustScene() {
        // 端末差による上余白/消失点の微調整が必要ならここで拡張
        // （今回のSVGは比率で描画済みのため、特段の処理は不要）
      }

      /* ==========================
         Init
      ========================== */
      window.addEventListener('load', () => {
        scheduleMinuteSync();
        setupWakeLockAutoReacquire();
        adjustScene();
      }, { once: true });

      window.addEventListener('resize', adjustScene);
    })();
  </script>
</body>
</html>
